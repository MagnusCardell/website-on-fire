import React, { forwardRef, useMemo } from 'react';
import type { Card as CardType, Suit } from '../engine/types';
import { cn } from '../lib/utils';

interface CardProps {
  card: CardType;
  isSelected?: boolean;
  isDragging?: boolean;
  isValidTarget?: boolean;
  style?: React.CSSProperties;
  onPointerDown?: (e: React.PointerEvent) => void;
  onPointerMove?: (e: React.PointerEvent) => void;
  onPointerUp?: (e: React.PointerEvent) => void;
  onPointerCancel?: (e: React.PointerEvent) => void;
  className?: string;
}

const suitSymbols: Record<Suit, string> = {
  hearts: '♥',
  diamonds: '♦',
  clubs: '♣',
  spades: '♠',
};

const suitColors: Record<Suit, string> = {
  hearts: 'text-red-600',
  diamonds: 'text-red-600',
  clubs: 'text-gray-900',
  spades: 'text-gray-900',
};

export const Card = forwardRef<HTMLDivElement, CardProps>(({
  card,
  isSelected,
  isDragging,
  isValidTarget,
  style,
  onPointerDown,
  onPointerMove,
  onPointerUp,
  onPointerCancel,
  className,
}, ref) => {
  const symbol = suitSymbols[card.suit];
  const colorClass = suitColors[card.suit];

  // Avoid SVG filter perf cliffs on iOS Safari.
  const reduceEffects = useMemo(() => {
    if (typeof window === 'undefined') return false;
    const ua = window.navigator.userAgent || '';
    const isIOS = /iPad|iPhone|iPod/.test(ua) || (ua.includes('Mac') && 'ontouchend' in document);
    const prefersReducedMotion = window.matchMedia?.('(prefers-reduced-motion: reduce)')?.matches ?? false;
    return isIOS || prefersReducedMotion;
  }, []);

  const handlePointerDown = (e: React.PointerEvent) => {
    // Make drag robust on iOS: keep receiving moves even if finger leaves element.
    try { (e.currentTarget as HTMLElement).setPointerCapture(e.pointerId); } catch {}
    onPointerDown?.(e);
  };
  const handlePointerMove = (e: React.PointerEvent) => onPointerMove?.(e);
  const handlePointerUp = (e: React.PointerEvent) => {
    try { (e.currentTarget as HTMLElement).releasePointerCapture(e.pointerId); } catch {}
    onPointerUp?.(e);
  };
  const handlePointerCancel = (e: React.PointerEvent) => {
    try { (e.currentTarget as HTMLElement).releasePointerCapture(e.pointerId); } catch {}
    onPointerCancel?.(e);
  };

  // Shared root styles (both face-up and face-down)
  const rootClass = cn(
    'absolute rounded-lg shadow-md select-none overflow-hidden',
    // "touch-none" is Tailwind touch-action: none (good for drag).
    'touch-none',
    className,
  );

  const rootStyle: React.CSSProperties = {
    width: 'var(--sol-card-w)',
    height: 'var(--sol-card-h)',
    // helps Safari composite transforms smoothly
    transformStyle: 'preserve-3d',
    WebkitTapHighlightColor: 'transparent',
    WebkitUserSelect: 'none',
    userSelect: 'none',
    ...style,
  };

  if (!card.faceUp) {
    return (
      <div
        ref={ref}
        data-card-id={card.id}
        className={cn(
          rootClass,
          'border-2 border-amber-700',
          'bg-gradient-to-br from-amber-900 via-amber-800 to-amber-950',
        )}
        style={rootStyle}
        onPointerDown={handlePointerDown}
        onPointerMove={handlePointerMove}
        onPointerUp={handlePointerUp}
        onPointerCancel={handlePointerCancel}
      >
        <div className="pointer-events-none absolute inset-[3px] rounded border border-amber-600/50" />
        <div className="pointer-events-none absolute inset-[6px] rounded border border-amber-500/30" />

        {/* Diamond lattice pattern background */}
        <div
          className="pointer-events-none absolute inset-[8px] rounded opacity-30"
          style={{
            backgroundImage: `
              linear-gradient(45deg, transparent 40%, rgba(255,215,0,0.4) 50%, transparent 60%),
              linear-gradient(-45deg, transparent 40%, rgba(255,215,0,0.4) 50%, transparent 60%)
            `,
            backgroundSize: '8px 8px',
          }}
        />

        {/* Center medallion with horse */}
        <div className="pointer-events-none absolute inset-0 flex items-center justify-center">
          <div className="relative w-8 h-10 flex items-center justify-center">
            <div className="absolute inset-0 rounded-[50%] border-[1.5px] border-amber-300/80 shadow-[inset_0_0_8px_rgba(251,191,36,0.3)]" />

            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="100 50 650 500"
              className={cn(
                'w-8 h-10',
                !reduceEffects && 'drop-shadow-[0_1px_2px_rgba(0,0,0,0.5)]'
              )}
              style={reduceEffects ? undefined : { filter: 'drop-shadow(0 0 2px rgba(255,215,0,0.35))' }}
              aria-hidden="true"
            >
              <path
                fill="#d4a017"
                d="M600.556,344.384c-1.567-5.375-5.729-22.602-6.758-29.078c-0.669-4.206-2.632-9.62-5.049-15.131
		c1.989-0.37,3.875-0.798,5.538-1.291c9.383-2.784,22.537-3.939,31.137-7.776c4.973-2.219,8.814-2.828,10.934-1.925
		c2.267,0.965,2.776,2.796,5.983,5.56c1.979,1.705-0.237,4.346-0.448,9.872c-0.21,5.526-3.263,16.812-5.637,22.78
		c-2.374,5.969-2.531,7.585-5.607,10.712c-3.077,3.127-3.156,7.377-3.654,10.897c-0.452,3.198-2.294,5.001-4.146,7.268
		c-1.851,2.267-3.543,5.238-7.168,6.069c-2.982,0.683-4.664,1.047-8.235,0.864c-0.403-0.021-0.812-0.065-1.227-0.122
		C603.969,357.052,601.804,348.666,600.556,344.384z M144.823,444.673c-4.475,2.462-16.559,10.965-20.14,15.217
		c8.056-5.371,16.112-7.832,26.853-7.832c10.741,0,24.839-1.119,29.315-16.336c-0.447,5.818-4.923,14.993-8.504,19.021
		c3.804-0.671,9.399-6.042,12.755-10.518c3.357-4.475,11.86-15.44,18.126-17.902c-3.133,2.685-6.042,8.951-7.832,12.755
		c-1.79,3.804-5.371,8.727-9.175,12.755c4.923-2.014,9.846-8.503,13.203-11.86c3.357-3.357,16.336-10.741,21.93-15.217
		c-2.685,5.595-15.217,19.245-22.74,24.258c17.902-2.685,41.761-28.957,49.146-53.349c-1.343,14.769-9.175,33.343-14.322,40.727
		c16.559-13.65,26.406-43.86,28.196-54.154c1.79,9.846-4.923,28.867-11.999,40.818c16.112-14.322,22.378-42.965,24.168-54.602
		c1.732-11.258,8.159-26.017,26.079-34.382c-0.203,1.854-0.36,3.689-0.445,5.468c-0.597,12.532,0.586,30.344,7.076,44.889
		c6.123,13.724,12.033,26.677,10.231,33.887c-2.626,10.505-5.909,18.383-9.192,26.262c-3.283,7.878-1.313,13.131,4.596,18.383
		c5.909,5.252,19.576,22.107,26.141,29.329c6.566,7.222,19.693,22.154,25.063,33.119c2.647,5.404,7.385,10.741,8.727,16.783
		c1.493,6.717,5.072,6.645,8.239,9.812c3.166,3.167,1.475,5.414,1.909,10.5c0.314,3.689,2.853,5.304,6.55,6.228
		c3.697,0.924,10.845,1.396,16.73,0.941c5.152-0.398,11.615-2.801,10.754-6.844c-0.917-4.309-2.812-8.707-5.214-11.841
		c-2.499-3.259-4.172-5.391-8.794-8.164s-5.048-5.597-8.215-8.764c-3.167-3.167-10.666-14.379-15.918-20.288
		c-5.252-5.909-20.035-32.178-25.287-40.056c-5.252-7.878-7.087-13.784-3.804-19.692c1.911-3.44,4.966-8.396,9.282-13.46
		c7.819,3.508,13.088,5.396,18.262,7.983c7.879,3.939,24.771,6.716,35.363,13.728c10.949,7.248,20.289,10.294,24.765,15.068
		c2.336,2.492,5.967,3.58,8.802,3.431c2.772-0.146,4.637-0.163,5.677,2.437c1.04,2.6,3.07,4.884,2.184,7.988
		c-0.887,3.104-2.217,5.321,0,9.312c2.217,3.991,7.538,9.756,11.973,12.416c4.435,2.661,5.321,4.434,7.095,0.444
		c1.774-3.991,3.991-11.53,5.321-16.407c1.33-4.878-0.887-10.642-2.217-14.19c-1.33-3.548-5.712-4.172-7.132-8.116
		c-1.007-2.797-3.218-5.265-5.818-6.825c-2.6-1.56-14.678-5.45-26.331-11.375c-13.203-6.713-23.47-13.767-30.732-17.156
		c-10.07-4.699-11.875-7.323-12.531-14.546c-0.208-2.283,0.677-6.751,1.672-11.562c0.508-2.456,0.925-4.864,1.161-7.631
		c7.797-8.295,16.092-21.235,18.083-32.848c6.968-2.323,10.87-5.003,16.59-6.719c15.665-4.699,38.455-8.763,52.922-9.208
		c21.567-0.664,38.188-3.978,49.935-12.111c7.835-5.424,13.77-10.452,20.401-18.148c0.838,2.218,2.317,4.67,3.423,6.847
		c2.617,5.155,10.412,16.495,14.937,22.896c4.524,6.401,11.595,23.895,14.969,29.001c3.375,5.106,2.84,10.922,1.742,15.102
		c-1.098,4.179-10.621,21.535-12.281,24.077c-1.661,2.542-4.935,3.668-6.839,7.139c-1.905,3.471-3.116,5.76-5.246,6.197
		c-2.102,0.431-3.194,1.866-3.94,3.359c-0.859,1.718-3.663,3.45-6.693,3.647c-3.03,0.197-4.883-0.965-6.04-3.149
		c-0.746-1.41-1.339-3.131-4.147-4.977c-2.903-1.908-4.336-3.415-7.631-3.982c-4.084-0.702-6.38,0.291-10.729,3.617
		c-4.348,3.326-8.941,7.58-10.796,11.809c-1.855,4.229-1.806,4.986,0.614,7.111c2.42,2.125,3.398,3.127,6.013,3.565
		c2.615,0.439,5.645,0.242,8.896,1.096c3.251,0.854,7.357,3.174,10.559,3.27c3.201,0.096,7.819-1.421,13.781-3.33
		c5.962-1.909,10.728-1.153,14.98-1.278c4.252-0.124,8.65-2.692,10.041-7.043c1.391-4.351,6.103-13.786,8.251-18.186
		c2.148-4.4,12.577-19.532,15.532-23.223c2.955-3.691,6.131-6.332,7.278-9.754c1.058-3.157,1.697-8.102,2.13-13.831
		c1.513-1.356,3.177-2.576,4.845-3.801c3.337-2.449,10.069-5.47,15.508-11.602c3.763-4.243,7.068-7.282,10.955-9.249
		c4.487-2.271,6.036-8.021,6.346-11.354c0.423-4.544,2.223-8.326,3.867-15.181c1.644-6.855,3.342-17.62,4.281-22.259
		c0.94-4.639,3.965-8.913,6.051-13.605c2.087-4.692,2.636-10.348,0.186-13.685c-2.449-3.337-4.848-4.696-6.958-8.164
		c-2.11-3.467-6.149-6.628-9.573-6.533c-4.375,0.121-9.142-0.278-14.178-1.1c-4.194-0.684-30.018-5.595-37.89-6.848
		c0.759-18.582-5.553-34.42-15.029-44.676c-7.479-8.095-14.323-17.697-15.075-30.728c-0.815-14.13-5.851-34.397-6.125-43.639
		s2.436-24.14,6.661-28.188c6.747,4.267,21.667,8.191,30.619,6.585c6.971-1.251,15.941,2.381,19.527,2.962
		c3.586,0.58,3.974,1.933,6.739,5.159c2.765,3.225,4.345,5.069,9.14,4.357c4.795-0.712,9.21-3.669,9.21-3.669
		s0.821-2.645-0.744-6.272c5.349,0.256,8.186-0.153,8.823-5.021c0.512-3.916,0.312-5.314-2.316-9.007
		c-1.796-2.524-0.067-5.52-1.251-8.056c-1.588-3.4-4.62-5.098-8.996-6.6c-4.376-1.502-15.507-6.38-21.44-12.4
		c-5.933-6.021-13.454-12.993-15.824-15.758c-2.37-2.765-6.087-2.186-10.689-9.767c-3.619-5.961-8.071-7.742-13.655-7.952
		c-4.154-3.129-6.307-13.316-11.53-17.668c-0.581-0.484-1.503-0.478-1.811,0.304c-2.005,5.088-2.668,10.147-0.044,14.49
		c-4.379-2.625-12.139-7.409-16.33-11.034c-0.582-0.504-1.101-0.359-1.267,0.429c-1.317,6.254,2.159,11.326,4.935,15.055
		c-11.862-3.401-26.696,1.575-33.848,6.982c-11.254,8.506-15.985,15.782-25.135,17.376c4.356,0.895,11.24-0.484,13.61-1.145
		c-3.07,2.18-13.302,5.015-17.128,6.562c-6.332,2.561-11.698,6.483-18.301,13.864c7.743-5.455,12.526-8.088,17.037-9.822
		c3.651-1.404,7.212-2.138,16.201-4.441c-10.867,3.935-17.815,9.242-22.134,16.043c-3.896,6.136-12.252,19.139-21.486,21.793
		c10.77-1.456,16.951-5.238,20.485-8.479c-3.828,6.755-13.187,13.089-19.476,17.244c-6.032,3.986-10.251,9.942-12.503,17.165
		c4.682-7.017,7.494-9.942,13.642-12.333c4.444-1.729,5.69-2.137,10.751-4.651c-6.971,4.002-10.671,6.129-13.57,9.494
		c-2.112,2.452-3.521,5.109-4.858,9.322c-1.212,3.819-3.284,8.882-6.982,11.52c4.022-0.272,7.493-3.161,9.466-5.2
		c2.28-2.356,4.247-4.815,9.708-6.64c-4.428,2.925-6.764,5.544-8.151,7.31c-1.388,1.766-7.02,8.002-9.263,9.858
		c-4.977,4.12-7.775,8.466-9.383,18.872c2.492-7.349,7.771-9.921,10.288-11.317c4.253-2.359,5.849-3.24,8.749-5.387
		c-5.154,7.302-10.814,20.667-17.715,25.679c3.078-1.091,10.006-3.781,12.809-5.935c-2.337,5.016-7.389,10.579-10.542,13.492
		c-3.154,2.914-5.44,7.706-6.709,11.676c2.807-4.043,6.461-5.551,9.315-6.984c2.853-1.433,5.119-2.64,10.422-6.496
		c-4.815,8.216-12.995,16.836-21.673,23.324c2.16-0.205,5.469-1.664,8.496-3.423c-14.647,20.518-31.999,31.474-49.97,37.459
		c-14.818,4.935-33.051,6.801-46.673,11.723c-13.315,4.811-23.722,14.057-30.649,23.471c-3.713,5.046-5.633,8.634-7.98,15.045
		c-19.076,7.705-32.087,4.644-53.469,18.329c-10.715,6.858-26.63,27.748-38.266,29.539c7.832,0.149,15.142-1.641,16.932-2.238
		c-4.625,3.133-16.559,8.504-24.168,9.846c5.818,0.448,12.83-0.783,21.11-4.476c-10.294,6.042-22.046,14.171-37.371,17.455
		c-15.665,3.357-22.825,11.413-29.986,25.063c6.713-7.832,15.358-13.178,19.17-14.993c4.699-2.238,10.07-2.536,13.949-2.909
		c-7.385,1.566-16.336,6.49-19.469,9.399c-3.133,2.909-14.322,16.261-21.333,19.618c5.072-2.089,7.534-0.149,13.054-4.401
		c-8.951,11.636-22.98,17.787-29.539,22.378c-8.951,6.266-15.217,16.783-17.902,27.525c2.685-4.476,5.147-7.385,8.28-9.399
		c-2.909,4.476-6.266,12.979-8.728,18.126C123.788,454.52,136.32,447.359,144.823,444.673z"
              />
            </svg>
          </div>
        </div>

        {/* Corner flourishes */}
        <div className="pointer-events-none absolute top-1.5 left-1.5 w-2 h-2 border-t-2 border-l-2 border-amber-500/60 rounded-tl-sm" />
        <div className="pointer-events-none absolute top-1.5 right-1.5 w-2 h-2 border-t-2 border-r-2 border-amber-500/60 rounded-tr-sm" />
        <div className="pointer-events-none absolute bottom-1.5 left-1.5 w-2 h-2 border-b-2 border-l-2 border-amber-500/60 rounded-bl-sm" />
        <div className="pointer-events-none absolute bottom-1.5 right-1.5 w-2 h-2 border-b-2 border-r-2 border-amber-500/60 rounded-br-sm" />

        <div className="pointer-events-none absolute inset-0 bg-gradient-to-br from-white/10 via-transparent to-transparent rounded-lg" />
      </div>
    );
  }

  // Dynamic type sizing via card width variable.
  // Assumes --sol-card-w is a px value (e.g. 60px, clamp(...px,...px,...px)).
  const rankStyle: React.CSSProperties = {
    fontSize: 'clamp(12px, calc(var(--sol-card-w) * 0.28), 20px)',
    lineHeight: 1,
  };
  const pipStyle: React.CSSProperties = {
    fontSize: 'clamp(10px, calc(var(--sol-card-w) * 0.22), 16px)',
    lineHeight: 1,
  };
  const centerStyle: React.CSSProperties = {
    fontSize: 'clamp(16px, calc(var(--sol-card-w) * 0.42), 28px)',
    lineHeight: 1,
  };

  return (
    <div
      ref={ref}
      data-card-id={card.id}
      className={cn(
        rootClass,
        'bg-white border border-gray-300',
        'transition-shadow duration-150',
        isSelected && 'ring-2 ring-amber-400 shadow-lg shadow-amber-400/30',
        isDragging && 'shadow-xl scale-105 z-50',
        isValidTarget && 'ring-2 ring-green-400',
        !isDragging && 'hover:shadow-lg',
      )}
      style={rootStyle}
      onPointerDown={handlePointerDown}
      onPointerMove={handlePointerMove}
      onPointerUp={handlePointerUp}
      onPointerCancel={handlePointerCancel}
    >
      {/* Top left rank and suit */}
      <div className={cn('absolute top-0 left-1.5 leading-none', colorClass)}>
        <div className="font-bold" style={rankStyle}>{card.rank}</div>
      </div>
      <div className={cn('absolute top-1 right-1 leading-none', colorClass)}>
        <div style={pipStyle}>{symbol}</div>
      </div>

      {/* Center suit */}
      <div className={cn('absolute inset-0 flex items-center justify-center', colorClass)}>
        <div style={centerStyle}>{symbol}</div>
      </div>

      {/* Bottom right rank and suit (inverted) */}
      <div className={cn('absolute bottom-0 right-1.5 leading-none rotate-180', colorClass)}>
        <div className="font-bold" style={rankStyle}>{card.rank}</div>
      </div>
      <div className={cn('absolute bottom-1 left-1 leading-none rotate-180', colorClass)}>
        <div style={pipStyle}>{symbol}</div>
      </div>
    </div>
  );
});

Card.displayName = 'Card';

// Empty pile placeholder
export function EmptyPile({
  type,
  isValidTarget,
  onClick,
  children,
}: {
  type: 'foundation' | 'tableau' | 'stock';
  isValidTarget?: boolean;
  onClick?: () => void;
  children?: React.ReactNode;
}) {
  return (
    <div
      className={cn(
        'rounded-lg border-2 border-dashed',
        'flex items-center justify-center',
        type === 'foundation' && 'border-green-600/40 bg-green-900/20',
        type === 'tableau' && 'border-gray-500/30 bg-gray-900/10',
        type === 'stock' && 'border-gray-500/30 bg-gray-900/20 cursor-pointer',
        isValidTarget && 'border-green-400 bg-green-400/20',
      )}
      style={{ width: 'var(--sol-card-w)', height: 'var(--sol-card-h)' }}
      onClick={onClick}
    >
      {children}
    </div>
  );
}
